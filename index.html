<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>eLiebermann: An Online Dictionary of Pre-Conquest English Law</title>

        <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
        <link rel="stylesheet" href="style.css" />

    </head>
    <body>
        <p><img src="images/banner.png" width="90%" alt="eLiebermann"/></p>
        <h1>An Online Dictionary of Pre-Conquest English Law</h1>
        <p>
            Liebermann, F. (Ed.). (2015). Die Gesetze der Angelsachsen: Herausgegeben im Auftrage der Savigny-Stiftung (Cambridge Library Collection - Medieval History). Cambridge: Cambridge University Press. doi:10.1017/CBO9781316225127
        </p>
        
        

        <p>
            Code: <a href="https://github.com/notamitchell/law">https://github.com/notamitchell/law</a><br/>
            Website: <a href="https://notamitchell.github.io/law/">https://notamitchell.github.io/law/</a>

        </p>
        
        <hr>
        
        <div>
            <h1>Page Number</h1>
            <p><em>Note: This is a page number as it appears in the original text, rather than the page of the PDF. </em></p>
            <input type="text" id="page_number" /> 
            &nbsp;
            <br>
        </div>

        <h1>Full Entry text</h1>
        <p><em>Copy and paste the full entry for a single word here. This should include bold, italic and superscript text.</em></p>

        <div id="editor-container"></div>


    <h1>Bosworth-Toller Link/s</h1>
    <div id="bt_links_container">
        <p class="link-row">
            Link text: <input type="text" class="bt_linkText" placeholder="e.g. Headword" /> 
            Link URL: <input type="url" class="bt_linkURL" placeholder="e.g. https://www.google.com/"/>
            <button type="button" class="remove-link-btn" onclick="this.parentNode.remove()">-</button>
        </p>
    </div>
    <button type="button" onclick="addLinkField('bt')">+ Add more Bosworth-Toller Links</button>
    <br>

    <hr>

    <h1>Dictionary of Old English Link/s</h1>
    <div id="dooe_links_container">
        <p class="link-row">
            Link text: <input type="text" class="dooe_linkText" placeholder="e.g. Headword" /> 
            Link URL: <input type="url" class="dooe_linkURL" placeholder="e.g. https://www.google.com/"/>
            <button type="button" class="remove-link-btn" onclick="this.parentNode.remove()">-</button>
        </p>
    </div>
    <button type="button" onclick="addLinkField('dooe')">+ Add more DOE Links</button>
    <br>

    <hr>

    <h1>Wiktionary Link/s</h1>
    <div id="wiktionary_links_container">
        <p class="link-row">
            Link text: <input type="text" class="wiktionary_linkText" placeholder="e.g. Headword" /> 
            Link URL: <input type="url" class="wiktionary_linkURL" placeholder="e.g. https://www.google.com/"/>
            <button type="button" class="remove-link-btn" onclick="this.parentNode.remove()">-</button>
        </p>
    </div>
    <button type="button" onclick="addLinkField('wiktionary')">+ Add more Wiktionary Links</button>
    <br>

    <hr>

    <h1>Law Code Citation Link/s</h1>
    <div id="lawCodeCitation_links_container">
        <p class="link-row">
            Link text: <input type="text" class="lawCodeCitation_linkText" placeholder="e.g. Headword" /> 
            Link URL: <input type="url" class="lawCodeCitation_linkURL" placeholder="e.g. https://www.google.com/"/>
            <button type="button" class="remove-link-btn" onclick="this.parentNode.remove()">-</button>
        </p>
    </div>
    <button type="button" onclick="addLinkField('lawCodeCitation')">+ Add more Law Code Citation Links</button>
    <br>

    <hr>



    <h1>English translation</h1>
    <div id="english-container"></div>
    <p><em>This button will create a preview of a webpage for your entry. You can always edit the information above and reprocess the text.</em></p>

    <p>
        <input type="button" value="Process" onclick="process_selection();" />
    </p>

    <p><em>The preview will appear below. Common problems:

        <ul>
            <li>An abbreviation or law code is not appearing as a link. </li>
            <ul>
                <li>
                    Check that the word/phrase is known in <a href="https://github.com/notamitchell/law/blob/main/data/markLaw.js">markLaw.js</a> or <a href="https://github.com/notamitchell/law/blob/main/data/markforward.js">markforward.js</a>.
                    There may be a varient like "3. Pers" versus "3.Pers".
                </li>
                <li></li>
            </ul>

        </ul>

    </em></p>

    <div id="output_html_rendered"> </div>

    <h1>HTML</h1>
    <p><em></em></p>
    <p>
        <textarea id="output_html_raw" rows="5" cols="100" ></textarea>
    </p>
    <p>&nbsp;</p>
            
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

    <script>
        // Define the custom toolbar with just bold, italic, and superscript.
        const toolbarOptions = [
          ['bold', 'italic'],
          [{ 'script': 'super' }],
        ];

        // Initialize Quill and configure it to use custom toolbar
        const quill = new Quill('#editor-container', {
          modules: {
            toolbar: toolbarOptions,
          },
          formats: ['bold', 'italic', 'script'],
          theme: 'snow', // The theme from the stylesheet.
        });


        const englishToolbarOptions = [
          ['bold', 'italic'],
          [{ 'script': 'super' }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ];

        const quillEnglish = new Quill('#english-container', {
          modules: {
            toolbar: englishToolbarOptions,
          },
          // ADDED 'list' to the allowed formats
          formats: ['bold', 'italic', 'script', 'list'],
          theme: 'snow', 
        });


    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }


    // JSONP to load markforward such as abbreviations from data folder
    var markforward  = {};
    function markforwardJSONP(jsonObj) {
        markforward = jsonObj;
    }


    // JSONP to load markLaw for law codes from data folder
    var markLaw  = {};
    function markLawJSONP(jsonObj) {
        markLaw = jsonObj;
    }

    function process_selection() {
        var output_html = "";
        var entryHTML = quill.root.innerHTML;
        var entry = quill.getText();
        
        //turn into one line
        entry = entry.replace(/\r/g, " ").replace(/\n/g, " ");
        
        var language = whatLanguage(entryHTML);
        var headWord = whatHeadWord(entry);
        var seeAlso = whatSeeAlso(entry);
        var page_number = document.getElementById("page_number").value;
        var LiebDefinition = parseEnumeratedListAsHtml(entryHTML);
        
        entry = entry.replace("~", "<span title='" + headWord + "'>~</span>");
        
        
        output_html = `
        <h1>${headWord}</h1>

        <p>${entryHTML}</p>

        <table>
            <tr>
                <th>Page Number</th>
                <th>Head Word</th>
                <th>Language</th>
                <th>See Also</th>
                <th>Full Entry</th>
                <th>Liebermann's Definition</th>
                <th>English Translation</th>
            </tr>
            <tr>
                <td>${document.getElementById("page_number").value}</td>
                <td>${headWord}</td>
                <td>${language}</td>
                <td>${seeAlso ? `<a href='${seeAlso}.html'>${seeAlso}</a>` : ''}</td>
                <td>${addLinks(entryHTML)}</td>
                <td>${addLinks(LiebDefinition)}</td>
                <td>${getMeaningfulContent(quillEnglish.root.innerHTML)}</td>
            </tr>
        </table>
        `;

        


        output_html += getLinksHTML('bt', 'Bosworth-Toller');
        output_html += getLinksHTML('dooe', 'Dictionary of Old English');
        output_html += getLinksHTML('wiktionary', 'Wiktionary');
        output_html += getLinksHTML('lawCodeCitation', 'Law Code Citation');
        


        
        
        document.getElementById('output_html_rendered').innerHTML = output_html;
        document.getElementById('output_html_raw').value = `<!DOCTYPE html>
            <head>
                <meta charset="utf-8">
                <title>${headWord} - eLiebermann: An Online Dictionary of Pre-Conquest English Law</title>
                <link rel="stylesheet" href="../style.css" />
            </head><body> ${output_html} </body></html>`;
        
    }

    function addLinks(someHTML) {
        console.log(someHTML);

        // Hacky. Temporarily change the superscript F to something else so that it doesn't mess up some special cases. 
        var returnStr = someHTML.replace("<sup><strong>F","<sup><strong>Frenchyness");

        const combinedTerms = [];
        // Add terms from markLaw
        markLaw.forEach(law => {
        combinedTerms.push({
            searchTerm: law["Gesetze Text"],
            data: {
            type: 'law',
            germanExpansion: law["German Expansion"],
            englishTranslation: law["English Translation"],
            anchor: law["Anchor"]
            }
        });
        });

        // Add terms from markforward
        markforward.forEach(forward => {
        combinedTerms.push({
            searchTerm: forward["Gesetze Text"],
            data: {
            type: 'forward',
            germanExpansion: forward["German Expansion"],
            englishTranslation: forward["English Translation"],
            anchor: forward["Anchor"]
            }
        });
        });

        // Sort the combined array by the length of the searchTerm, longest to shortest
        combinedTerms.sort((a, b) => b.searchTerm.length - a.searchTerm.length);

        // Loop through the sorted, combined array
        for (const item of combinedTerms) {
            var searchTerm = item.searchTerm;
            
            var escapedSearchTerm = escapeRegex(searchTerm);

            var escapedSearchTermForRegex = escapedSearchTerm.replace(/\s+/g, '\\s+');

            var regex = new RegExp('(?<!<a[^>]*?>)\\b' + escapedSearchTermForRegex + '\\b(?!<\\/a>)', 'g');

            var anchor = item.data.anchor;

            if (item.data.type === 'law') {
                returnStr = returnStr.replace(regex, '<a href="../lawAbb.html#' + encodeURIComponent(anchor) + '" >' + searchTerm + '</a>');
            } else if (item.data.type === 'forward') {
                returnStr = returnStr.replace(regex, '<a href="../gramAbb.html#' + encodeURIComponent(anchor) + '"><abbr>' + searchTerm + '</abbr></a>');
            }
        }

        // Revert the temporary change
        returnStr = returnStr.replace("<sup><strong>Frenchyness","<sup><strong>F");
        return returnStr;
    }


    
    function whatLanguage(htmlString) {
        // Give this function an entry and it will tell you what language it is.
        // Entries starting with superscript L are Latin
        // Entries starting with superscript F are French
        // Entries that do not start with a superscript, but instead have a bold and italic word are "Grammatical Term"
        // Default Old English

        const tempElement = document.createElement('div');
        tempElement.innerHTML = htmlString.trim();

        // The HTML is always inside a p tag, so get the first child which should be the p element.
        const pElement = tempElement.firstElementChild;

        // Get the first child of the p element.
        const firstChild = pElement.firstElementChild;

        // Check if the first child is a superscript element (<sup>).
        if (firstChild && firstChild.tagName === 'SUP') {
            const supContent = firstChild.textContent.trim();
            if (supContent.includes('L')) {
                return 'Latin';
            }
            if (supContent.includes('F')) {
                return 'French';
            }
        } 

        if (firstChild && firstChild.tagName === 'STRONG') {
            // Check if the first child of the strong element is an em element.
            const strongFirstChild = firstChild.firstElementChild;
            if (strongFirstChild && strongFirstChild.tagName === 'EM') {
                return 'Grammatical Term';
            }
        }

        // Default to Old English if no match is found.
        return 'Old English';
    }
    
    function whatHeadWord(str) {
        // Give this function an entry and it will tell you what the head word (i.e. the dictionary word of this entry)

        // note the order or removal is important here. It might get rid of I) and then F superscript
        // Remove "I) ", "II) ", "III) "
        if (str.startsWith("I) ") || str.startsWith("II) ") || str.startsWith("III) ")) {
            str = str.substring(str.indexOf(" ") + 1);
        }
        
        if (str.substring(0, 2) == "L ") {
            str = str.substring(2);
        }
        
        if (str.substring(0, 2) == "F ") {
            str = str.substring(2);
        }


        return str.split(" ")[0];
        
    }
    
    function whatSeeAlso(str) {
        // The .s indicate a See Also. See another entry. 
        // e.g. abere s. aebaere
        // e.g. localization s. localisation
        
        var n = str.search(" s. ");
        
        
        if (n < 0) {
            return "";
        } else {
            return str.split(" s. ")[1].trim();
        }
        
    }




function parseEnumeratedListAsHtml(htmlString) {
    const regex = /(\d+)<\/strong>\)\s*(.*?)(?=(<strong>|$))/g;
    const listItems = [];
    let match;

    // Loop through all matches in the string.
    while ((match = regex.exec(htmlString)) !== null) {
        // The content is in the second capturing group (match[2]).
        const content = match[2].trim();
        if (content) {
            listItems.push(content);
        }
    }

    // Return nothing (undefined) if no list items were found.
    if (listItems.length === 0) {
        return "";
    }

    return `<ol>\n${listItems.map(item => `  <li>${item}</li>`).join('\n')}\n</ol>`;
}


const getMeaningfulContent = (htmlContent) => {
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  const trimmedText = tempDiv.textContent.trim();

  // If there's meaningful text, return the original HTML, otherwise return an empty string or a placeholder
  return trimmedText.length > 0 ? htmlContent : '';
};

function addLinkField(prefix) {
    const container = document.getElementById(prefix + '_links_container');
    const newLinkRow = document.createElement('p');
    newLinkRow.className = 'link-row'; // Use a class for easier styling/selection
    
    // Use the prefix to ensure the classes are correct for the new fields
    newLinkRow.innerHTML = `
        Link text: <input type="text" class="${prefix}_linkText" placeholder="e.g. Headword" /> 
        Link URL: <input type="url" class="${prefix}_linkURL" placeholder="e.g. https://www.google.com/"/>
        <button type="button" class="remove-link-btn" onclick="this.parentNode.remove()">-</button>
    `;
    container.appendChild(newLinkRow);
}

function getLinksHTML(prefix, displayTitle) {
    const textInputs = document.querySelectorAll(`.${prefix}_linkText`);
    const urlInputs = document.querySelectorAll(`.${prefix}_linkURL`);
    
    const links = [];

    // The NodeList objects (textInputs and urlInputs) have the same length and correspond by index.
    for (let i = 0; i < textInputs.length; i++) {
        const linkText = textInputs[i].value.trim();
        const linkURL = urlInputs[i].value.trim();
        
        // Only add a link if both text and a valid looking URL are present
        if (linkText !== "") { 
            const linkHTML = `<a href="${linkURL}" target="_blank">${linkText}</a>`;
            links.push(linkHTML);
        }
    }

    let outputHTML = "";
    if (links.length > 0) {
        outputHTML += "<ul>";
        for (const link of links) {
            // Use the displayTitle passed into the function
            outputHTML += `<li>${displayTitle}: ${link}</li>`;
        }
        outputHTML += "</ul>";
    }
    
    return outputHTML;
}
  
</script>     
<script src="data/markforward.js"></script>
<script src="data/markLaw.js"></script>





    </body>
</html>
