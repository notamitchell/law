<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statuta Vetera: Manuscript Search</title>
    <link rel="stylesheet" href="../style.css" />
    <style>

        /* New Filter Layout */
        .search-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            background: #f4f4f4; 
            padding: 15px; 
            border-radius: 8px;
        }
        .search-container input[type="text"] { flex-grow: 1; padding: 8px; }

        .filters-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 30px;
        }

        .facet-group { margin-bottom: 10px; }
        .facet-title { font-weight: bold; display: block; margin-bottom: 8px; font-size: 0.85rem; color: #333; text-transform: uppercase; }
        
        .range-inputs { display: flex; gap: 5px; }
        .range-inputs input { width: 100%; padding: 6px; font-size: 0.8em; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Table Styles */
        #table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        .highlight { background-color: #ffeb3b; font-weight: bold; padding: 0 2px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                           background: rgba(255,255,255,0.8); display: flex; 
                           justify-content: center; align-items: center; z-index: 1000; }
        
        .reset-btn { background: #666; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; align-self: flex-end; }
        .reset-btn:hover { background: #444; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay"><h3>Indexing TEI Documents...</h3></div>

    <div id="main-content">
        <h1>Statuta Vetera</h1>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search manuscripts...">
            <select id="searchScope">
                <option value="all">Everywhere</option>
                <option value="title">Title Only</option>
                <option value="settlement">Settlement Only</option>
                <option value="repository">Repository Only</option>
            </select>
            <button id="searchButton" style="padding: 8px 20px; cursor:pointer;">Search</button>
        </div>

        <div class="filters-grid">
            <div class="facet-group">
                <span class="facet-title">Settlement</span>
                <select id="settlementFacet" style="width:100%; padding: 6px;"><option value="">All Locations</option></select>
            </div>
            
            <div class="facet-group">
                <span class="facet-title">Repository</span>
                <select id="repositoryFacet" style="width:100%; padding: 6px;"><option value="">All Repositories</option></select>
            </div>

            <div class="facet-group">
                <span class="facet-title">Leaf Dimensions (mm)</span>
                <div class="range-inputs">
                    <input type="number" id="lHMin" placeholder="Min H">
                    <input type="number" id="lHMax" placeholder="Max H">
                </div>
                <div class="range-inputs" style="margin-top:5px;">
                    <input type="number" id="lWMin" placeholder="Min W">
                    <input type="number" id="lWMax" placeholder="Max W">
                </div>
            </div>

            <div class="facet-group">
                <span class="facet-title">Written Dimensions (mm)</span>
                <div class="range-inputs">
                    <input type="number" id="wHMin" placeholder="Min H">
                    <input type="number" id="wHMax" placeholder="Max H">
                </div>
                <div class="range-inputs" style="margin-top:5px;">
                    <input type="number" id="wWMin" placeholder="Min W">
                    <input type="number" id="wWMax" placeholder="Max W">
                </div>
            </div>

            <button onclick="resetFilters()" class="reset-btn">Reset Filters</button>
        </div>
        
        <div id="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Settlement / Repository</th>
                        <th>Leaf (H x W)</th>
                        <th>Written (H x W)</th>
                        <th>Bibliography</th>
                        <th>Provenance</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const CONFIG = {
            user: 'notamitchell',
            repo: 'law',
            path: 'tei',
            pagesBase: 'https://notamitchell.github.io/law/tei/'
        };

        let allDocs = [];

        async function init() {
            try {
                const response = await fetch(`https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents/${CONFIG.path}`);
                const files = await response.json();
                const xmlFiles = files.filter(f => f.name.endsWith('.xml'));

                const promises = xmlFiles.map(async file => {
                    const res = await fetch(file.download_url);
                    const text = await res.text();
                    const xml = new DOMParser().parseFromString(text, "text/xml");

                    const getTEI = (tag) => xml.getElementsByTagName(tag)[0]?.textContent?.trim() || "";
                    const getDim = (type, dimension) => {
                        const node = xml.querySelector(`dimensions[type="${type}"] ${dimension}`);
                        return node ? parseInt(node.textContent) : null;
                    };

                    const titleStmt = xml.getElementsByTagName("titleStmt")[0];
                    const fullTitle = titleStmt?.getElementsByTagName("title")[0]?.textContent?.trim() || "Untitled";

                    return {
                        title: fullTitle,
                        settlement: getTEI("settlement"),
                        repository: getTEI("repository"),
                        provenance: getTEI("provenance"), 
                        bibl: getTEI("bibl"),  
                        leafH: getDim("leaf", "height"),
                        leafW: getDim("leaf", "width"),
                        writtenH: getDim("written", "height"),
                        writtenW: getDim("written", "width"),
                        url: CONFIG.pagesBase + file.name,
                        content: xml.documentElement.textContent.replace(/\s+/g, ' ').trim()
                    };
                });

                allDocs = await Promise.all(promises);
                populateFacets(allDocs);
                renderTable(allDocs);
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = "Error loading files.";
            }
        }

        function renderTable(docs, searchTerm = "") {
            const body = document.getElementById('resultsBody');
            body.innerHTML = docs.map(doc => {
                const leafDim = (doc.leafH && doc.leafW) ? `${doc.leafH}x${doc.leafW}` : "-";
                const writDim = (doc.writtenH && doc.writtenW) ? `${doc.writtenH}x${doc.writtenW}` : "-";
                
                return `
                    <tr>
                        <td><a href="${doc.url}" target="_blank" style="text-decoration:none; color:#2c3e50; font-weight:bold;">${doc.title}</a></td>
                        <td>${doc.settlement}<br><small style="color:#777">${doc.repository}</small></td>
                        <td>${leafDim}</td>
                        <td>${writDim}</td>
                        <td>${doc.bibl}</td>
                        <td>${doc.provenance}</td>
                    </tr>
                `;
            }).join('');
        }



        function filterDocs() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sett = document.getElementById('settlementFacet').value;
            const repo = document.getElementById('repositoryFacet').value;
            
            const filters = {
                lhMin: parseInt(document.getElementById('lHMin').value),
                lhMax: parseInt(document.getElementById('lHMax').value),
                lwMin: parseInt(document.getElementById('lWMin').value),
                lwMax: parseInt(document.getElementById('lWMax').value),
                whMin: parseInt(document.getElementById('wHMin').value),
                whMax: parseInt(document.getElementById('wHMax').value),
                wwMin: parseInt(document.getElementById('wWMin').value),
                wwMax: parseInt(document.getElementById('wWMax').value)
            };

            const filtered = allDocs.filter(doc => {
                const matchSearch = !search || doc.title.toLowerCase().includes(search) || doc.content.toLowerCase().includes(search);
                const matchSett = !sett || doc.settlement === sett;
                const matchRepo = !repo || doc.repository === repo;

                const inRange = (val, min, max) => (!min || (val && val >= min)) && (!max || (val && val <= max));

                return matchSearch && matchSett && matchRepo &&
                       inRange(doc.leafH, filters.lhMin, filters.lhMax) &&
                       inRange(doc.leafW, filters.lwMin, filters.lwMax) &&
                       inRange(doc.writtenH, filters.whMin, filters.whMax) &&
                       inRange(doc.writtenW, filters.wwMin, filters.wwMax);
            });

            renderTable(filtered, search);
        }

        function populateFacets(docs) {
            const settlements = [...new Set(docs.map(d => d.settlement).filter(s => s))].sort();
            const repositories = [...new Set(docs.map(d => d.repository).filter(r => r))].sort();
            
            const sSelect = document.getElementById('settlementFacet');
            settlements.forEach(s => sSelect.add(new Option(s, s)));

            const rSelect = document.getElementById('repositoryFacet');
            repositories.forEach(r => rSelect.add(new Option(r, r)));
        }

        function resetFilters() {
            const ids = ['searchInput', 'settlementFacet', 'repositoryFacet', 'lHMin', 'lHMax', 'lWMin', 'lWMax', 'wHMin', 'wHMax', 'wWMin', 'wWMax'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = "";
            });
            renderTable(allDocs);
        }

        document.getElementById('searchButton').addEventListener('click', filterDocs);
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', filterDocs);
        });

        init();
    </script>
</body>
</html>
