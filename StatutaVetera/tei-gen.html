<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEI Manuscript Header Generator</title>
    <style>
        body { font-family: -apple-system, sans-serif; line-height: 1.4; padding: 20px; max-width: 1000px; margin: 0 auto; background-color: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #1a73e8; margin-top: 0; }
        h2 { font-size: 1.1em; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; color: #555; }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
        .form-grid { display: grid; grid-template-columns: 120px 1fr 120px 1fr; gap: 10px; align-items: center; }
        .form-grid label { font-weight: bold; font-size: 0.85em; }
        .form-grid input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .span-3 { grid-column: span 3; }
        button { background-color: #1a73e8; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        button:hover { background-color: #1557b0; }
        #output { background-color: #1e1e1e; color: #d4d4d4; height: 350px; font-size: 0.9em; }
        .filename-container { background: #e8f0fe; padding: 15px; border-radius: 4px; border: 1px dashed #1a73e8; margin-top: 10px; display: flex; align-items: center; gap: 10px; }
        #filenameDisplay { font-family: monospace; font-weight: bold; color: #1557b0; }
    </style>
</head>
<body>

    <h1>TEI Manuscript Generator</h1>

    <div class="card">
        <h2>1. Paste Source Text</h2>
        <textarea id="rawInput" placeholder="Cambridge, Trinity College MS O.2.58..."></textarea>
        <button onclick="extractData()">Process Text &rarr;</button>
    </div>

    <div class="card">
        <h2>2. Refine Form Data</h2>
        <div class="form-grid">
            <label>Settlement</label><input type="text" id="f_settlement" class="span-3">
            <label>Repository</label><input type="text" id="f_repository" class="span-3">
            <label>ID Number</label><input type="text" id="f_idno" class="span-3">
            <label>Content (i.e. other Title in TEI)</label><input type="text" id="f_title" class="span-3">
            <label>Extent (ff)</label><input type="text" id="f_extent">
            <div style="grid-column: span 2;"></div>
            <label>Leaf Height</label><input type="text" id="f_lHeight">
            <label>Leaf Width</label><input type="text" id="f_lWidth">
            <label>Text Height</label><input type="text" id="f_tHeight">
            <label>Text Width</label><input type="text" id="f_tWidth">
            <label>Provenance</label><input type="text" id="f_provenance" class="span-3">
            <label>Bibliography</label><input type="text" id="f_bibl" class="span-3">
        </div>
        <br>
        <button onclick="generateTEI()" style="background-color: #28a745;">Generate Final TEI XML</button>
    </div>

    <div class="card">
        <h2>3. Generated TEI Output</h2>
        <textarea id="output" readonly></textarea>
        
        <div class="filename-container">
            <span>Suggested Filename:</span>
            <span id="filenameDisplay">Pending...</span>
        </div>
        <br>
        <button onclick="copyToClipboard()">Copy XML</button>
        <p>Now save this XML file to your machine. Then upload to github (https://github.com/notamitchell/law/tree/main/tei).</p>
    </div>

<script>
    function extractData() {
        const text = document.getElementById('rawInput').value;
        const setRep = text.match(/^([^,]+),\s*([^ \n]+ [^ \n]+)/);
        const idno = text.match(/(MS\s[A-Z0-9\.]+)/);
        const title = text.match(/\.\s*([^;.]+;[^.]+)\./);
        const extent = text.match(/(\d+\s*ff)/);
        const dims = [...text.matchAll(/(\d+)\s*x\s*(\d+)/g)];
        const provMatch = text.match(/(Provenance:\s*.*)/i);
        const biblMatch = text.match(/(Bibliography:\s*.*)/i);

        if(setRep) {
            document.getElementById('f_settlement').value = setRep[1].trim();
            document.getElementById('f_repository').value = setRep[2].trim();
        }
        document.getElementById('f_idno').value = idno ? idno[1].trim() : '';
        document.getElementById('f_title').value = title ? title[1].trim() : '';
        document.getElementById('f_extent').value = extent ? extent[1].trim() : '';
        if (dims.length > 0) { document.getElementById('f_lHeight').value = dims[0][1]; document.getElementById('f_lWidth').value = dims[0][2]; }
        if (dims.length > 1) { document.getElementById('f_tHeight').value = dims[1][1]; document.getElementById('f_tWidth').value = dims[1][2]; }
        document.getElementById('f_provenance').value = provMatch ? provMatch[1].trim() : 'Provenance: ';
        document.getElementById('f_bibl').value = biblMatch ? biblMatch[1].trim() : 'Bibliography: ';
    }

    function generateTEI() {
        const getV = (id) => document.getElementById(id).value;
        const rawText = document.getElementById('rawInput').value;

        // Create sanitized filename
        const baseTitle = `${getV('f_settlement')}-${getV('f_repository')}-${getV('f_idno')}`;
        const safeFilename = baseTitle
            .toLowerCase()
            .replace(/[^a-z0-9]/g, '-') // Replace non-alphanumeric with hyphens
            .replace(/-+/g, '-')       // Remove double hyphens
            .replace(/^-|-$/g, '')     // Trim hyphens from ends
            + '.xml';
        
        document.getElementById('filenameDisplay').innerText = safeFilename;

        const formattedBody = rawText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').split('\n').join('<lb/>\n        ');
        
        const tei = `<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.tei-c.org/release/xml/tei/custom/schema/relaxng/tei_all.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<TEI xmlns="http://www.tei-c.org/ns/1.0">
  <teiHeader>
    <fileDesc>
      <titleStmt>
        <title>${getV('f_settlement')}, ${getV('f_repository')}, ${getV('f_idno')}</title>
      </titleStmt>
      <publicationStmt>
        <p>Documented for TEI project.</p>
      </publicationStmt>
      <sourceDesc>
        <msDesc>
          <msIdentifier>
            <settlement>${getV('f_settlement')}</settlement>
            <repository>${getV('f_repository')}</repository>
            <idno>${getV('f_idno')}</idno>
          </msIdentifier>
          <msContents>
            <msItem>
              <title>${getV('f_title')}</title>
            </msItem>
          </msContents>
          <physDesc>
            <objectDesc form="codex">
              <supportDesc material="parchment">
                <extent>${getV('f_extent')}
                  <dimensions type="leaf" unit="mm">
                    <height>${getV('f_lHeight')}</height>
                    <width>${getV('f_lWidth')}</width>
                  </dimensions>
                </extent>
              </supportDesc>
              <layoutDesc>
                <layout columns="1">
                  <dimensions type="written" unit="mm">
                    <height>${getV('f_tHeight')}</height>
                    <width>${getV('f_tWidth')}</width>
                  </dimensions>
                  <p>Text block measuring ${getV('f_tHeight')} x ${getV('f_tWidth')} mm.</p>
                </layout>
              </layoutDesc>
            </objectDesc>
          </physDesc>
          <history>
            <provenance>${getV('f_provenance')}</provenance>
          </history>
          <additional>
            <listBibl>
              <bibl>${getV('f_bibl')}</bibl>
            </listBibl>
          </additional>
        </msDesc>
      </sourceDesc>
    </fileDesc>
  </teiHeader>
  <text>
    <body>
      <p>
        ${formattedBody}
      </p>
    </body>
  </text>
</TEI>`;

        document.getElementById('output').value = tei;
    }

    function copyToClipboard() {
        const output = document.getElementById('output');
        output.select();
        document.execCommand('copy');
        alert("XML copied!");
    }

    function downloadXML() {
        const text = document.getElementById('output').value;
        const filename = document.getElementById('filenameDisplay').innerText;
        if (!text) { alert("Please generate the TEI first!"); return; }
        
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/xml;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
</script>
</body>
</html>
